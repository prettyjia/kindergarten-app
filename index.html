import React, { useState, useEffect } from 'react';
import {
  View,
  Text,
  StyleSheet,
  TouchableOpacity,
  FlatList,
  ActivityIndicator,
  Alert,
  TextInput,
  Modal
} from 'react-native';
import { getAuth, signOut } from 'firebase/auth';
import { getTeacherClasses, createClass, getChildren } from './firebase';

const HomeScreen = ({ navigation }) => {
  const [classes, setClasses] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showNewClassModal, setShowNewClassModal] = useState(false);
  const [newClassName, setNewClassName] = useState('');
  const [selectedColor, setSelectedColor] = useState('#FF9800');
  const [childrenCounts, setChildrenCounts] = useState({});

  const auth = getAuth();
  const user = auth.currentUser;

  const colorOptions = [
    '#FF9800', // ì˜¤ë Œì§€
    '#4CAF50', // ì´ˆë¡
    '#2196F3', // íŒŒë‘
    '#E91E63', // ë¶„í™
    '#9C27B0', // ë³´ë¼
    '#FF5722', // ë¹¨ê°•
  ];

  useEffect(() => {
    loadClasses();
  }, []);

  const loadClasses = async () => {
    setLoading(true);
    const result = await getTeacherClasses();
    
    if (result.success) {
      setClasses(result.data);
      
      // ê° ë°˜ì˜ ì•„ì´ ìˆ˜ ì¡°íšŒ
      const counts = {};
      for (const classItem of result.data) {
        const childrenResult = await getChildren(classItem.id);
        if (childrenResult.success) {
          counts[classItem.id] = childrenResult.data.length;
        }
      }
      setChildrenCounts(counts);
    }
    
    setLoading(false);
  };

  const handleCreateClass = async () => {
    if (!newClassName.trim()) {
      Alert.alert('ì•Œë¦¼', 'ë°˜ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    const result = await createClass(newClassName, selectedColor);
    
    if (result.success) {
      Alert.alert('ì„±ê³µ', 'ìƒˆ ë°˜ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
      setShowNewClassModal(false);
      setNewClassName('');
      setSelectedColor('#FF9800');
      loadClasses();
    } else {
      Alert.alert('ì˜¤ë¥˜', 'ë°˜ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  };

  const handleLogout = () => {
    Alert.alert(
      'ë¡œê·¸ì•„ì›ƒ',
      'ì •ë§ ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
      [
        { text: 'ì·¨ì†Œ', style: 'cancel' },
        {
          text: 'ë¡œê·¸ì•„ì›ƒ',
          style: 'destructive',
          onPress: async () => {
            await signOut(auth);
            navigation.replace('Login');
          }
        }
      ]
    );
  };

  const renderClassCard = ({ item }) => {
    const childCount = childrenCounts[item.id] || 0;

    return (
      <TouchableOpacity
        style={[styles.classCard, { borderLeftColor: item.color }]}
        onPress={() => navigation.navigate('ChildList', {
          classId: item.id,
          className: item.name,
          classColor: item.color
        })}
      >
        <View style={styles.classCardHeader}>
          <View style={[styles.colorCircle, { backgroundColor: item.color }]} />
          <Text style={styles.className}>{item.name}</Text>
        </View>
        
        <View style={styles.classInfo}>
          <Text style={styles.infoText}>ğŸ‘¶ ì•„ì´ {childCount}ëª…</Text>
        </View>

        <View style={styles.cardFooter}>
          <Text style={styles.footerText}>íƒ­í•˜ì—¬ ê´€ë¦¬í•˜ê¸°</Text>
          <Text style={styles.arrow}>â†’</Text>
        </View>
      </TouchableOpacity>
    );
  };

  if (loading) {
    return (
      <View style={styles.loadingContainer}>
        <ActivityIndicator size="large" color="#FF9800" />
        <Text style={styles.loadingText}>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</Text>
      </View>
    );
  }

  return (
    <View style={styles.container}>
      {/* í—¤ë” */}
      <View style={styles.header}>
        <View>
          <Text style={styles.greeting}>ì•ˆë…•í•˜ì„¸ìš”! ğŸ‘‹</Text>
          <Text style={styles.userName}>{user?.displayName || user?.email || 'ì„ ìƒë‹˜'}</Text>
        </View>
        <TouchableOpacity 
          style={styles.settingsButton}
          onPress={handleLogout}
        >
          <Text style={styles.settingsIcon}>âš™ï¸</Text>
        </TouchableOpacity>
      </View>

      {/* ë°˜ ëª©ë¡ */}
      <View style={styles.content}>
        <Text style={styles.sectionTitle}>ë‚´ ë°˜ ëª©ë¡</Text>
        
        {classes.length === 0 ? (
          <View style={styles.emptyContainer}>
            <Text style={styles.emptyIcon}>ğŸ“š</Text>
            <Text style={styles.emptyText}>ì•„ì§ ë§Œë“  ë°˜ì´ ì—†ì–´ìš”</Text>
            <Text style={styles.emptySubText}>ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì²« ë°˜ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”!</Text>
          </View>
        ) : (
          <FlatList
            data={classes}
            renderItem={renderClassCard}
            keyExtractor={item => item.id}
            contentContainerStyle={styles.listContainer}
            showsVerticalScrollIndicator={false}
          />
        )}
      </View>

      {/* ìƒˆ ë°˜ ë§Œë“¤ê¸° ë²„íŠ¼ */}
      <TouchableOpacity
        style={styles.addButton}
        onPress={() => setShowNewClassModal(true)}
      >
        <Text style={styles.addButtonText}>â• ìƒˆ ë°˜ ë§Œë“¤ê¸°</Text>
      </TouchableOpacity>

      {/* ìƒˆ ë°˜ ë§Œë“¤ê¸° ëª¨ë‹¬ */}
      <Modal
        visible={showNewClassModal}
        transparent={true}
        animationType="slide"
        onRequestClose={() => setShowNewClassModal(false)}
      >
        <View style={styles.modalOverlay}>
          <View style={styles.modalContent}>
            <Text style={styles.modalTitle}>ìƒˆ ë°˜ ë§Œë“¤ê¸°</Text>
            
            <TextInput
              style={styles.input}
              placeholder="ë°˜ ì´ë¦„ (ì˜ˆ: ì‚¬ë‘ë°˜, ê¸°ì¨ë°˜)"
              value={newClassName}
              onChangeText={setNewClassName}
              maxLength={20}
            />

            <Text style={styles.colorLabel}>ë°˜ ìƒ‰ìƒ ì„ íƒ</Text>
            <View style={styles.colorOptions}>
              {colorOptions.map(color => (
                <TouchableOpacity
                  key={color}
                  style={[
                    styles.colorOption,
                    { backgroundColor: color },
                    selectedColor === color && styles.colorOptionSelected
                  ]}
                  onPress={() => setSelectedColor(color)}
                >
                  {selectedColor === color && (
                    <Text style={styles.checkmark}>âœ“</Text>
                  )}
                </TouchableOpacity>
              ))}
            </View>

            <View style={styles.modalButtons}>
              <TouchableOpacity
                style={[styles.modalButton, styles.cancelButton]}
                onPress={() => {
                  setShowNewClassModal(false);
                  setNewClassName('');
                  setSelectedColor('#FF9800');
                }}
              >
                <Text style={styles.cancelButtonText}>ì·¨ì†Œ</Text>
              </TouchableOpacity>
              
              <TouchableOpacity
                style={[styles.modalButton, styles.confirmButton]}
                onPress={handleCreateClass}
              >
                <Text style={styles.confirmButtonText}>ë§Œë“¤ê¸°</Text>
              </TouchableOpacity>
            </View>
          </View>
        </View>
      </Modal>
    </View>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#FFF8E1'
  },
  loadingContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    backgroundColor: '#FFF8E1'
  },
  loadingText: {
    marginTop: 12,
    fontSize: 16,
    color: '#757575'
  },
  header: {
    backgroundColor: '#FFFFFF',
    padding: 24,
    paddingTop: 48,
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    borderBottomWidth: 1,
    borderBottomColor: '#E0E0E0'
  },
  greeting: {
    fontSize: 16,
    color: '#757575',
    marginBottom: 4
  },
  userName: {
    fontSize: 24,
    fontWeight: 'bold',
    color: '#424242'
  },
  settingsButton: {
    padding: 8
  },
  settingsIcon: {
    fontSize: 28
  },
  content: {
    flex: 1,
    padding: 20
  },
  sectionTitle: {
    fontSize: 20,
    fontWeight: 'bold',
    color: '#424242',
    marginBottom: 16
  },
  listContainer: {
    paddingBottom: 20
  },
  classCard: {
    backgroundColor: '#FFFFFF',
    borderRadius: 16,
    padding: 20,
    marginBottom: 16,
    borderLeftWidth: 6,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.1,
    shadowRadius: 8,
    elevation: 4
  },
  classCardHeader: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: 12
  },
  colorCircle: {
    width: 12,
    height: 12,
    borderRadius: 6,
    marginRight: 12
  },
  className: {
    fontSize: 22,
    fontWeight: 'bold',
    color: '#424242'
  },
  classInfo: {
    marginBottom: 12
  },
  infoText: {
    fontSize: 16,
    color: '#757575',
    marginBottom: 4
  },
  cardFooter: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    paddingTop: 12,
    borderTopWidth: 1,
    borderTopColor: '#F5F5F5'
  },
  footerText: {
    fontSize: 14,
    color: '#FF9800',
    fontWeight: '600'
  },
  arrow: {
    fontSize: 18,
    color: '#FF9800'
  },
  emptyContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    paddingVertical: 60
  },
  emptyIcon: {
    fontSize: 64,
    marginBottom: 16
  },
  emptyText: {
    fontSize: 18,
    color: '#424242',
    marginBottom: 8
  },
  emptySubText: {
    fontSize: 14,
    color: '#9E9E9E',
    textAlign: 'center'
  },
  addButton: {
    backgroundColor: '#FF9800',
    margin: 20,
    padding: 18,
    borderRadius: 30,
    alignItems: 'center',
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 4 },
    shadowOpacity: 0.3,
    shadowRadius: 8,
    elevation: 6
  },
  addButtonText: {
    color: '#FFFFFF',
    fontSize: 18,
    fontWeight: 'bold'
  },
  modalOverlay: {
    flex: 1,
    backgroundColor: 'rgba(0, 0, 0, 0.5)',
    justifyContent: 'center',
    alignItems: 'center',
    padding: 20
  },
  modalContent: {
    backgroundColor: '#FFFFFF',
    borderRadius: 20,
    padding: 24,
    width: '100%',
    maxWidth: 400
  },
  modalTitle: {
    fontSize: 22,
    fontWeight: 'bold',
    color: '#424242',
    marginBottom: 20,
    textAlign: 'center'
  },
  input: {
    backgroundColor: '#F5F5F5',
    borderRadius: 12,
    padding: 16,
    fontSize: 16,
    marginBottom: 20,
    borderWidth: 1,
    borderColor: '#E0E0E0'
  },
  colorLabel: {
    fontSize: 16,
    fontWeight: '600',
    color: '#424242',
    marginBottom: 12
  },
  colorOptions: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    marginBottom: 24
  },
  colorOption: {
    width: 48,
    height: 48,
    borderRadius: 24,
    justifyContent: 'center',
    alignItems: 'center',
    borderWidth: 3,
    borderColor: 'transparent'
  },
  colorOptionSelected: {
    borderColor: '#424242'
  },
  checkmark: {
    color: '#FFFFFF',
    fontSize: 24,
    fontWeight: 'bold'
  },
  modalButtons: {
    flexDirection: 'row',
    gap: 12
  },
  modalButton: {
    flex: 1,
    padding: 16,
    borderRadius: 12,
    alignItems: 'center'
  },
  cancelButton: {
    backgroundColor: '#F5F5F5'
  },
  cancelButtonText: {
    color: '#757575',
    fontSize: 16,
    fontWeight: '600'
  },
  confirmButton: {
    backgroundColor: '#FF9800'
  },
  confirmButtonText: {
    color: '#FFFFFF',
    fontSize: 16,
    fontWeight: 'bold'
  }
});

export default HomeScreen;
